<!DOCTYPE html>
<html lang="en">

<head>
    <title> Orbit Player </title>
    <link rel="icon" href="img/orbit_ico_blue.png">
    <link rel="stylesheet" href="css/styles.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>

    <header>
        <p><a href="start.html"><img src="img/orbit_white.png" width="140" height="50" title="Orbit Player"></a></p>

        <p>
            <a href="explore.html"> Explore </a> •
            <a href="news.html"> Updates </a>
        </p>

        <!-- Botão fixo Switch Theme -->
        <button id="fixedButton" onclick="toggleDarkMode()">Switch Theme</button>

    </header>

    <main>
        <article>

            <p align="center">
                <input type="text" id="search" onkeyup="search()" placeholder="Search music..." width="300" height="40">

                <button onclick="skipSong()">Skip</button>
                <button id="repeatButton">Repeat Off</button>
            </p>

            <ul align="center" id="results"></ul>

            <article>

            </article>

            <aside>
            </aside>
    </main>

    <footer>

        <p align="center" id="tituloMusica"></p>

        <p align="center">
            <audio id="audioPlayer" controls>
                <source id="audioSource" src="" type="audio/mp3">
                Seu navegador não suporta a tag de áudio.
            </audio>
        </p>

    </footer>

    <script>
        // lightmode script
        function toggleDarkMode() {
            const body = document.body;
            body.classList.toggle('light-mode');
        }
        // anti right-click protection
        document.addEventListener('contextmenu', function (e) {
            e.preventDefault();
        });
    </script>

    <script>
        var data = [
            { title: "30 seconds to mars - From Yesterday", url: "music/rock/30 seconds to mars - From Yesterday.mp3" },
            { title: "3030 - Alma De Cigana", url: "music/rap/3030 - Alma De Cigana.mp3" },
            { title: "3030 - Brilho Na Alma", url: "music/rap/3030 - Brilho Na Alma.mp3" },
            { title: "3030 - Fé", url: "music/rap/3030 - Fé.mp3" },
            { title: "3030 - Lunar", url: "music/rap/3030 - Lunar.mp3" },

        ];

        var ul = document.getElementById("results");

        var isRepeat = false; // Flag para indicar se a repetição está ativada

        // Adiciona o evento de clique ao botão de repetição
        document.getElementById('repeatButton').addEventListener('click', function () {
            isRepeat = !isRepeat;
            this.textContent = isRepeat ? 'Repeat On' : 'Repeat Off'; // Atualiza o texto do botão
            updateMediaSessionActions();
        });

        for (var i = 0; i < data.length; i++) {
            var li = document.createElement("li");
            var a = document.createElement("a");
            a.href = "#";
            a.onclick = function (index) {
                return function () {
                    changeAudioSource(index);
                };
            }(i);
            a.textContent = data[i].title;
            li.appendChild(a);
            ul.appendChild(li);
            li.style.display = "none";
        }

        function changeAudioSource(index) {
            var audio = document.getElementById('audioPlayer');
            var source = document.getElementById('audioSource');

            source.src = data[index].url;
            audio.load();
            audio.play();
            displayCurrentSongTitle(data[index].title);
        }

        function search() {
            var input = document.getElementById("search");
            var filter = normalizeString(input.value.toUpperCase());
            var ul = document.getElementById("results");
            var li = ul.getElementsByTagName("li");

            for (var i = 0; i < li.length; i++) {
                var a = li[i].getElementsByTagName("a")[0];
                var txtValue = normalizeString(a.textContent || a.innerText);

                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    li[i].style.display = "";
                } else {
                    li[i].style.display = "none";
                }
            }

            if (filter.length == 0) {
                ul.style.display = "none";
            } else {
                ul.style.display = "block";
            }
        }

        function normalizeString(str) {
            return str.normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/ç/g, 'c').replace(/Ç/g, 'C');
        }

        function displayCurrentSongTitle(title) {
            var tituloMusica = document.getElementById("tituloMusica");
            tituloMusica.textContent = title;

            var artist = title.split(" - ")[0];
            var songTitle = title.split(" - ")[1];
            var artworkUrl = 'img/orbit_ico.png'; // Substitua com o caminho da sua imagem de logo

            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: songTitle,
                    artist: artist,
                    artwork: [
                        { src: artworkUrl, sizes: '96x96', type: 'image/png' },
                        { src: artworkUrl, sizes: '128x128', type: 'image/png' },
                        { src: artworkUrl, sizes: '192x192', type: 'image/png' },
                        { src: artworkUrl, sizes: '256x256', type: 'image/png' },
                        { src: artworkUrl, sizes: '384x384', type: 'image/png' },
                        { src: artworkUrl, sizes: '512x512', type: 'image/png' },
                    ]
                });
            }
        }

        // Script de reprodução aleatória
        var audioPlayer = document.getElementById('audioPlayer');
        var audioSource = document.getElementById('audioSource');

        function getRandomTrack() {
            var randomIndex = Math.floor(Math.random() * data.length);
            return data[randomIndex];
        }

        function playRandom() {
            var randomTrack = getRandomTrack();
            audioSource.src = randomTrack.url;
            audioPlayer.load();
            audioPlayer.play();
            displayCurrentSongTitle(randomTrack.title);
        }

        function skipSong() {
            playRandom();
        }

        if ('mediaSession' in navigator) {
            navigator.mediaSession.setActionHandler('play', () => {
                audioPlayer.play();
            });

            navigator.mediaSession.setActionHandler('pause', () => {
                audioPlayer.pause();
            });

            navigator.mediaSession.setActionHandler('nexttrack', () => {
                skipSong();
            });

            // Define metadados inicialmente
            displayCurrentSongTitle(data[0].title);
            updateMediaSessionActions();
        }

        function updateMediaSessionActions() {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.setActionHandler('previoustrack', null);
                navigator.mediaSession.setActionHandler('nexttrack', null);
                navigator.mediaSession.setActionHandler('seekbackward', null);
                navigator.mediaSession.setActionHandler('seekforward', null);

                navigator.mediaSession.setActionHandler('seekbackward', () => {
                    isRepeat = !isRepeat;
                    document.getElementById('repeatButton').textContent = isRepeat ? 'Repeat On' : 'Repeat Off';
                });

                navigator.mediaSession.setActionHandler('nexttrack', () => {
                    skipSong();
                });

                const actions = [
                    {
                        action: isRepeat ? 'seekbackward' : 'previoustrack',
                        icon: isRepeat ? 'repeat_icon_url' : 'shuffle_icon_url'
                    },
                    { action: 'play', icon: 'play_icon_url' },
                    { action: 'pause', icon: 'pause_icon_url' },
                    { action: 'nexttrack', icon: 'next_icon_url' },
                ];

                navigator.mediaSession.setActionHandlers(actions);
            }
        }

        // Evento para detectar o fim da música e agir conforme a repetição ou reprodução aleatória
        audioPlayer.addEventListener('timeupdate', function () {
            if (isRepeat && audioPlayer.duration - audioPlayer.currentTime < 0.25) {
                audioPlayer.currentTime = 0; // Reseta o tempo da música para o início
                audioPlayer.play(); // Reproduz novamente a música atual
            }
        });

        audioPlayer.addEventListener('ended', function () {
            if (!isRepeat) {
                playRandom(); // Passa para a próxima música aleatória
            }
        });

        // Inicie a reprodução com a primeira música aleatória
        playRandom();
    </script>

</body>

</html>
